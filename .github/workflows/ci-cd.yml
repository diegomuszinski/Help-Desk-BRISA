name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, appmod/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '20'
  POSTGRES_VERSION: '15'

jobs:
  # Job 1: Backend Build & Test
  backend-build:
    name: Backend - Build & Test
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: helpdesk
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        working-directory: ./helpdesk-backend/helpdesk-api
        run: chmod +x gradlew

      - name: Build backend
        working-directory: ./helpdesk-backend/helpdesk-api
        run: ./gradlew build --no-daemon -x test
        env:
          JAVA_HOME: ${{ env.JAVA_HOME }}

      - name: Run backend tests
        working-directory: ./helpdesk-backend/helpdesk-api
        run: ./gradlew test --no-daemon -Dspring.profiles.active=test
        env:
          SPRING_PROFILES_ACTIVE: test
          JWT_SECRET: ${{ secrets.JWT_SECRET_TEST || 'test-secret-key-minimum-32-characters-long-for-testing' }}

      - name: Upload backend test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: helpdesk-backend/helpdesk-api/build/reports/tests/
          retention-days: 7

      - name: Upload backend JAR
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: helpdesk-backend/helpdesk-api/build/libs/*.jar
          retention-days: 7

  # Job 2: Frontend Build & Test
  frontend-build:
    name: Frontend - Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: help-desk-frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./help-desk-frontend
        run: npm ci

      - name: Lint frontend
        working-directory: ./help-desk-frontend
        run: npm run lint || true

      - name: Build frontend
        working-directory: ./help-desk-frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: help-desk-frontend/dist/
          retention-days: 7

  # Job 3: E2E Tests with Playwright
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: helpdesk
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: help-desk-frontend/package-lock.json

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download backend JAR
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./backend-jar

      - name: Start backend server (let it create tables first)
        working-directory: ./backend-jar
        run: |
          # Use a random high port to avoid conflicts
          BACKEND_PORT=$((20000 + RANDOM % 10000))
          echo "Using random backend port: $BACKEND_PORT"
          echo "BACKEND_PORT=$BACKEND_PORT" >> $GITHUB_ENV
          
          echo "Starting backend server..."
          nohup java -jar *-SNAPSHOT.jar --server.port=$BACKEND_PORT > backend.log 2>&1 &
          echo $! > backend.pid
          echo "Backend PID: $(cat backend.pid)"
          echo "Waiting for backend to initialize and create tables..."
          sleep 20
          if ps -p $(cat backend.pid) > /dev/null; then
            echo "‚úÖ Backend process is running"
            echo "Initial logs:"
            head -n 100 backend.log
          else
            echo "‚ùå Backend process failed to start!"
            echo "Full logs:"
            cat backend.log
            exit 1
          fi
        env:
          DB_URL: jdbc:postgresql://localhost:5432/helpdesk
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          JWT_SECRET: ${{ secrets.JWT_SECRET_TEST || 'test-secret-key-minimum-32-characters-long-for-testing' }}
          SPRING_PROFILES_ACTIVE: dev

      - name: Wait for backend to be ready
        run: |
          echo "Waiting for backend on port ${{ env.BACKEND_PORT }}..."
          for i in {1..60}; do
            if curl -f http://localhost:${{ env.BACKEND_PORT }}/actuator/health/liveness 2>/dev/null; then
              echo "‚úÖ Backend liveness probe passed!"
              if curl -f http://localhost:${{ env.BACKEND_PORT }}/actuator/health 2>/dev/null; then
                echo "‚úÖ Backend full health check passed!"
                break
              fi
            fi
            echo "‚è≥ Waiting for backend... ($i/60)"
            sleep 3
          done
          
          if ! curl -f http://localhost:${{ env.BACKEND_PORT }}/actuator/health 2>/dev/null; then
            echo "‚ùå Backend failed to start"
            cat ./backend-jar/backend.log
            exit 1
          fi
          
          echo "‚úÖ Backend is fully ready!"

      - name: Initialize database with test data
        run: |
          echo "=== Inserting test users into existing tables ==="
          
          # Check tables were created by backend
          echo "1. Verifying tables exist..."
          table_count=$(PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d helpdesk -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';")
          echo "Found $table_count tables"
          
          if [ "$table_count" -lt 5 ]; then
            echo "‚ùå ERROR: Backend didn't create enough tables. Found: $table_count"
            PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d helpdesk -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';"
            exit 1
          fi
          
          # Now insert test data using only the INSERT statements
          echo ""
          echo "2. Inserting test data..."
          PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d helpdesk <<'EOF'
          -- Insert categories
          INSERT INTO categorias (nome) VALUES
          ('Toner/Cartucho'),
          ('Software (Office, Adobe, etc.)'),
          ('Software (Sistema Operacional)'),
          ('Hardware (HD, mem√≥ria, etc.)'),
          ('Permiss√£o de acesso (pasta, arquivo)'),
          ('D√∫vidas/Outros')
          ON CONFLICT (nome) DO NOTHING;
          
          -- Insert priorities
          INSERT INTO prioridades (nome) VALUES
          ('Baixa'),
          ('M√©dia'),
          ('Alta'),
          ('Cr√≠tica')
          ON CONFLICT (nome) DO NOTHING;
          
          -- Insert team
          INSERT INTO equipes (id, nome_equipe, id_gestor) VALUES
          (1, 'Equipe Suporte T√©cnico', NULL)
          ON CONFLICT (id) DO NOTHING;
          
          -- Insert test users
          INSERT INTO usuarios (id, nome, email, senha, perfil, id_equipe) VALUES
          (1, 'Administrador do Sistema', 'admin@admin.net', '\$2a\$10\$N9qo8uLOickgx2ZMRZoMye6J4Qf8mKvjeyELCtU3xbGQEUzLe6T7e', 'ADMIN', NULL),
          (2, 'S√¥nia Lima', 'sonia.lima@gestor.net', '\$2a\$10\$3Lkj8vFqNHnLMnXbXKYB0eDVYBfQxX5z5qVzKQl5N/B3Q8XCxqh2O', 'MANAGER', 1),
          (3, 'Mariana Silva', 'mariana@tecnico.net', '\$2a\$10\$N9qo8uLOickgx2ZMRZoMye6J4Qf8mKvjeyELCtU3xbGQEUzLe6T7e', 'TECHNICIAN', 1),
          (4, 'Usu√°rio de Teste', 'usuario@teste.net', '\$2a\$10\$N9qo8uLOickgx2ZMRZoMye6J4Qf8mKvjeyELCtU3xbGQEUzLe6T7e', 'USER', NULL)
          ON CONFLICT (id) DO NOTHING;
          
          -- Update team manager
          UPDATE equipes SET id_gestor = 2 WHERE id = 1;
          EOF
          
          echo "‚úÖ Test data inserted!"
          
          # Verify users
          echo ""
          echo "3. Verifying users were created..."
          PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d helpdesk -c "SELECT id, nome, email, perfil FROM usuarios ORDER BY id;"
          
          user_count=$(PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d helpdesk -t -c "SELECT COUNT(*) FROM usuarios;")
          echo ""
          echo "Total users: $user_count"
          
          if [ "$user_count" -lt 4 ]; then
            echo "‚ùå ERROR: Expected 4 users, found $user_count"
            exit 1
          fi
          
          echo "‚úÖ All test users verified!"

      - name: Verify database initialization was successful
        run: |
          echo "=== Double-checking database state before starting backend ==="
          
          # Check if tables exist
          echo "1. Checking if tables exist..."
          table_count=$(PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d helpdesk -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';")
          echo "Found $table_count tables in database"
          
          if [ "$table_count" -lt 5 ]; then
            echo "‚ùå ERROR: Expected at least 5 tables, found $table_count"
            echo "Tables found:"
            PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d helpdesk -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE' ORDER BY table_name;"
            exit 1
          fi
          
          # Check specific user exists with correct email
          echo ""
          echo "2. Checking if usuario@teste.net exists..."
          user_exists=$(PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d helpdesk -t -c "SELECT COUNT(*) FROM usuarios WHERE email = 'usuario@teste.net';")
          
          if [ "$user_exists" -eq 0 ]; then
            echo "‚ùå ERROR: User usuario@teste.net does not exist!"
            echo "All users in database:"
            PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d helpdesk -c "SELECT id, nome, email FROM usuarios;"
            exit 1
          fi
          
          echo "‚úÖ User usuario@teste.net exists"
          
          # Show the password hash for debugging
          echo ""
          echo "3. Checking password hash..."
          PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d helpdesk -c "SELECT id, email, LEFT(senha, 20) || '...' as senha_hash, perfil FROM usuarios WHERE email = 'usuario@teste.net';"
          
          echo ""
          echo "‚úÖ Database is properly initialized and ready!"

      - name: Install frontend dependencies
        working-directory: ./help-desk-frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./help-desk-frontend
        run: npx playwright install --with-deps chromium

      - name: Start frontend dev server
        working-directory: ./help-desk-frontend
        run: |
          echo "Starting frontend dev server..."
          echo "Creating .env.local with CI configuration..."
          echo "VITE_API_BASE_URL=http://localhost:${{ env.BACKEND_PORT }}" > .env.local
          cat .env.local
          echo ""
          echo "Starting Vite dev server..."
          nohup npm run dev > frontend.log 2>&1 &
          echo $! > frontend.pid
          echo "Frontend PID: $(cat frontend.pid)"
          sleep 5
          if ps -p $(cat frontend.pid) > /dev/null; then
            echo "‚úÖ Frontend process is running"
            echo "Frontend logs (first 50 lines):"
            head -n 50 frontend.log
          else
            echo "‚ùå Frontend process failed to start!"
            cat frontend.log
            exit 1
          fi

      - name: Wait for frontend to be ready
        run: |
          echo "Waiting for frontend to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:5173 2>/dev/null; then
              echo "‚úÖ Frontend is ready!"
              exit 0
            fi
            echo "‚è≥ Waiting for frontend... ($i/30)"
            sleep 2
          done
          echo "‚ùå Frontend failed to start within timeout"
          echo "Frontend logs:"
          cat ./help-desk-frontend/frontend.log
          exit 1

      - name: Verify backend API is accessible
        run: |
          echo "=== Testing backend connectivity ==="
          
          echo "1. Testing health endpoint..."
          if curl -f http://localhost:${{ env.BACKEND_PORT }}/actuator/health 2>/dev/null; then
            echo "‚úÖ Health endpoint responding"
          else
            echo "‚ùå Health endpoint not responding"
            echo "Backend logs:"
            cat ./backend-jar/backend.log
            exit 1
          fi
          
          echo ""
          echo "2. Testing login endpoint with POST request..."
          response=$(curl -X POST http://localhost:${{ env.BACKEND_PORT }}/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"usuario@teste.net","senha":"123456"}' \
            -w "\n%{http_code}" \
            -s)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "HTTP Status: $http_code"
          echo "Response body: $body"
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
            echo "‚úÖ Login endpoint is working! Authentication successful!"
            # Extract token to verify it's valid JSON
            if echo "$body" | grep -q "token"; then
              echo "‚úÖ JWT token received in response"
            fi
          else
            echo "‚ùå Login failed with status $http_code"
            echo "This will cause E2E test failures!"
            exit 1
          fi
          
          echo ""
          echo "3. Checking if frontend can reach backend..."
          if curl -f http://localhost:5173 -s | grep -q "localhost:${{ env.BACKEND_PORT }}\|VITE_API"; then
            echo "‚úÖ Frontend may be configured with backend URL"
          else
            echo "‚ö†Ô∏è Could not detect backend URL in frontend"
          fi
          
          echo ""
          echo "=== All connectivity checks passed ==="

      - name: Run Playwright tests
        working-directory: ./help-desk-frontend
        run: npm run test:e2e
        env:
          BASE_URL: http://localhost:5173
          API_URL: http://localhost:${{ env.BACKEND_PORT }}

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: help-desk-frontend/playwright-report/
          retention-days: 7

      - name: Stop frontend server
        if: always()
        run: |
          if [ -f help-desk-frontend/frontend.pid ]; then
            kill $(cat help-desk-frontend/frontend.pid) || true
          fi

      - name: Stop backend server
        if: always()
        run: |
          if [ -f backend-jar/backend.pid ]; then
            kill $(cat backend-jar/backend.pid) || true
          fi

  # Job 4: Load Testing with K6
  load-tests:
    name: Load Testing (K6)
    runs-on: ubuntu-latest
    needs: [backend-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: helpdesk
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download backend JAR
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./backend-jar

      - name: Start backend server
        working-directory: ./backend-jar
        run: |
          echo "Starting backend server..."
          ls -la
          nohup java -jar *-SNAPSHOT.jar > backend.log 2>&1 &
          echo $! > backend.pid
          echo "Backend PID: $(cat backend.pid)"
          echo "Waiting for backend to initialize..."
          sleep 15
          if ps -p $(cat backend.pid) > /dev/null; then
            echo "‚úÖ Backend process is running"
            echo "Initial logs:"
            head -n 100 backend.log
          else
            echo "‚ùå Backend process failed to start!"
            echo "Full logs:"
            cat backend.log
            exit 1
          fi
        env:
          DB_URL: jdbc:postgresql://localhost:5432/helpdesk
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          JWT_SECRET: ${{ secrets.JWT_SECRET_TEST || 'test-secret-key-minimum-32-characters-long-for-testing' }}
          SERVER_PORT: 18080
          SPRING_PROFILES_ACTIVE: dev

      - name: Wait for backend to be ready
        run: |
          echo "Waiting for backend health check..."
          for i in {1..60}; do
            # Try liveness probe first (more lenient)
            if curl -f http://localhost:18080/actuator/health/liveness 2>/dev/null; then
              echo "‚úÖ Backend liveness probe passed!"
              # Now try full health check
              if curl -f http://localhost:18080/actuator/health 2>/dev/null; then
                echo "‚úÖ Backend full health check passed!"
                exit 0
              else
                echo "‚ö†Ô∏è Liveness OK but full health failing, retrying..."
              fi
            fi
            echo "‚è≥ Waiting for backend... ($i/60)"
            sleep 3
          done
          echo "‚ùå Backend failed to start within timeout"
          echo "=== Backend logs ==="
          cat ./backend-jar/backend.log
          echo ""
          echo "=== Checking if backend is listening on port 8080 ==="
          netstat -tuln | grep 8080 || echo "Port 8080 is not open"
          exit 1

      - name: Install K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run K6 load test
        working-directory: ./helpdesk-backend/k6-tests
        run: k6 run load-test.js
        env:
          BASE_URL: http://localhost:18080

      - name: Upload K6 results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-results
          path: helpdesk-backend/k6-tests/results/
          retention-days: 7

      - name: Stop backend server
        if: always()
        run: |
          if [ -f backend-jar/backend.pid ]; then
            kill $(cat backend-jar/backend.pid) || true
          fi

  # Job 5: Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (Backend)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './helpdesk-backend'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'

      - name: Upload Trivy results for Backend to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-backend-results.sarif'
          category: 'trivy-backend'

      - name: Run Trivy vulnerability scanner (Frontend)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './help-desk-frontend'
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'

      - name: Upload Trivy results for Frontend to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-frontend-results.sarif'
          category: 'trivy-frontend'

  # Job 6: Code Quality Analysis
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: SonarCloud Scan
        if: env.SONAR_TOKEN != ''
        working-directory: ./helpdesk-backend/helpdesk-api
        run: ./gradlew sonar --info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}

  # Job 7: Deploy to Staging (on main branch)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build, e2e-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://helpdesk-staging.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backend JAR
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./deploy

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ./deploy/frontend

      - name: Deploy to staging
        run: |
          echo "üöÄ Deploying to staging environment..."
          echo "Backend JAR: ./deploy/*.jar"
          echo "Frontend: ./deploy/frontend/"
          # Add your deployment commands here
          # Examples:
          # - SCP/RSYNC to staging server
          # - Deploy to Azure App Service
          # - Deploy to AWS Elastic Beanstalk
          # - Deploy to Heroku
          # - Deploy to Docker registry

      - name: Notify deployment
        if: always()
        run: |
          echo "‚úÖ Deployment to staging completed"
          # Add notification commands here (Slack, Discord, Email, etc.)

  # Job 8: Deploy to Production (manual approval)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging, load-tests, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://helpdesk.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backend JAR
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./deploy

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ./deploy/frontend

      - name: Deploy to production
        run: |
          echo "üöÄ Deploying to production environment..."
          echo "Backend JAR: ./deploy/*.jar"
          echo "Frontend: ./deploy/frontend/"
          # Add your production deployment commands here

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: Notify deployment
        if: always()
        run: |
          echo "‚úÖ Deployment to production completed"
          # Add notification commands here
